#!/usr/sbin/nft -f

# =============================================================
# nftables-konfiguration för lastbalansering
# =============================================================

flush ruleset

# NAT-tabell för omdirigering och masquerading
table ip nat {
    # Prerouting-kedja: Omdirigera inkommande trafik på port 80
    chain prerouting {
        type nat hook prerouting priority 0; policy accept;
        
        # Omdirigera trafik på port 80 till applikationsservrarna
        # Round-robin load balancing mellan 172.20.0.11:5000 och 172.20.0.12:5000
        # numgen roterar mellan 0 och 1 for att vaxa mellan app1 och app2
        tcp dport 80 dnat to numgen inc mod 2 map { 0 : 172.20.0.11 . 5000, 1 : 172.20.0.12 . 5000 }
    }
    
    # Postrouting-kedja: Masquerade utgående trafik
    chain postrouting {
        type nat hook postrouting priority 100; policy accept;
        masquerade
    }
}

# Filter-tabell för brandväggsregler
table ip filter {
    chain input {
        type filter hook input priority 0; policy accept;
        
        # Acceptera alla loopback
        iif lo accept
        
        # Acceptera etablerade anslutningar
        ct state established,related accept
        
        # Acceptera incoming HTTP
        tcp dport 80 accept
    }
    
    chain forward {
        type filter hook forward priority 0; policy accept;
        
        # Acceptera all forward traffic
        accept
    }
}
